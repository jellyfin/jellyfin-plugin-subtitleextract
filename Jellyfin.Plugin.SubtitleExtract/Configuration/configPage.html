<!DOCTYPE html>
<html>
<head>
    <title>Jellyfin Subtitle Extractor</title>
</head>
<body>
<div data-role="page" class="page type-interior pluginConfigurationPage subsExtractorConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-linkbutton">

    <div data-role="content">
        <div class="content-primary">

            <form class="extractorConfigurationForm">
                <br/>

                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label>
                        <input is="emby-checkbox" type="checkbox" id="chkEnableDuringScan"/>
                        <span>Extract subtitles and attachments during library scan</span>
                    </label>
                    <div class="fieldDescription checkboxFieldDescription">This will make sure subtitles and attachments are extracted sooner but will result in longer library scans. Does not disable the scheduled task.</div>
                </div>

                <div class="folderAccessListContainer" style="margin-bottom: -1em;">
                    <div class="folderAccess">
                        <h3 class="checkboxListLabel">Limit subtitle extraction to the following libraries (if nothing is selected, all libraries will be included)</h3>
                        <div class="checkboxList paperList" style="padding: 0.5em 1em;" id="librarySubtitlesCheckboxes"></div>
                    </div>
                    <label class="inputLabel" for="SelectedSubtitlesLibraries"></label>
                    <input id="SelectedSubtitlesLibraries" type="hidden" is="emby-input"/>
                </div>

                <div class="folderAccessListContainer" style="margin-bottom: -1em;">
                    <div class="folderAccess">
                        <h3 class="checkboxListLabel">Limit attachment extraction to the following libraries (if nothing is selected, all libraries will be included)</h3>
                        <div class="checkboxList paperList" style="padding: 0.5em 1em;" id="libraryAttachmentsCheckboxes"></div>
                    </div>
                    <label class="inputLabel" for="SelectedAttachmentsLibraries"></label>
                    <input id="SelectedAttachmentsLibraries" type="hidden" is="emby-input"/>
                </div>

                <!-- Easy Mode Section -->
                <div id="easyModeSection">
                    <h3 class="checkboxListLabel">Subtitle Types to Extract</h3>
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="chkTextSubtitles"/>
                            <span>Text Subtitles</span>
                        </label>
                        <div class="fieldDescription checkboxFieldDescription">Includes: SRT, ASS/SSA, WebVTT, and other text-based subtitle formats. It will extract subtitles from medias containing only text subtitles.</div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="chkGraphicalSubtitles"/>
                            <span>Graphical Subtitles</span>
                        </label>
                        <div class="fieldDescription checkboxFieldDescription">Includes: DVD subtitles (VOBSUB), Blu-ray subtitles (PGS), and other image-based formats. It will extract subtitles from medias containing at least one graphical subtitle.</div>
                    </div>
                </div>

                <!-- Advanced Mode Toggle -->
                <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 1.5em;">
                    <label>
                        <input is="emby-checkbox" type="checkbox" id="chkAdvancedMode"/>
                        <span>Advanced Mode</span>
                    </label>
                    <div class="fieldDescription checkboxFieldDescription">Enable advanced codec selection for fine-grained control</div>
                </div>

                <details id="codecsDetails">
                    <summary style="cursor: pointer; padding: 10px; width: inherit; margin: auto; border: none; text-align: center; font-size: 1em; outline: 2px solid rgba(155, 155, 155, 0.5);">
                        Codecs to include in extraction
                    </summary>
                    <div class="folderAccessListContainer" style="margin-bottom: -1em;">
                        <div class="folderAccess">
                            <h3 class="checkboxListLabel">Limit subtitle extraction to media with all subtitle streams matching the selected codecs.</h3>
                            <div class="checkboxList paperList" style="padding: 0.5em 1em;" id="includedCodecsCheckboxes"></div>
                        </div>
                        <label class="inputLabel" for="SelectedCodecs"></label>
                        <input id="SelectedCodecs" type="hidden" is="emby-input"/>
                    </div>
                </details>

                <br/>
                <div>
                    <button is="emby-button" type="submit" class="raised button-submit block emby-button"><span>Save</span></button>
                </div>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        function updateList(textField, container) {
            textField.value = Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
                .map((checkbox) => checkbox.nextElementSibling.textContent)
                .join(", ");
        }

        function generateCheckboxList(items, containerId, textFieldId) {
            const container = document.getElementById(containerId);
            const checkedItems = new Set(document.getElementById(textFieldId).value.split(", ").filter(Boolean));
            const fragment = document.createDocumentFragment();
            for (const item of items) {
                const label = document.createElement("label");
                label.className = "emby-checkbox-label";
                label.innerHTML = '<input type="checkbox" is="emby-checkbox"' + (checkedItems.has(item) ? " checked" : "") + ">" + '<span class="checkboxLabel">' + item + "</span>";
                fragment.appendChild(label);
            }
            container.innerHTML = "";
            container.appendChild(fragment);
            container.addEventListener(
                "change",
                (e) => {
                    if (e.target.type === "checkbox") updateList(document.getElementById(textFieldId), container);
                },
                {passive: true}
            );
        }

        async function populateLibraries() {
            const response = await getJson("Library/VirtualFolders");
            const tvLibraries = response.filter((item) => item.CollectionType === undefined || item.CollectionType === "tvshows" || item.CollectionType === "movies");
            const libraryNames = tvLibraries.map((lib) => lib.Name || "Unnamed Library");
            generateCheckboxList(libraryNames, "librarySubtitlesCheckboxes", "SelectedSubtitlesLibraries");
            generateCheckboxList(libraryNames, "libraryAttachmentsCheckboxes", "SelectedAttachmentsLibraries");
        }

        async function getJson(url) {
            return await fetchWithAuth(url, "GET")
                .then((r) => {
                    if (r.ok) {
                        return r.json();
                    } else {
                        return null;
                    }
                })
                .catch((err) => {
                    console.debug(err);
                });
        }

        // make an authenticated fetch to the server
        async function fetchWithAuth(url, method, body) {
            url = ApiClient.serverAddress() + "/" + url;

            const reqInit = {
                method: method,
                headers: {
                    Authorization: "MediaBrowser Token=" + ApiClient.accessToken(),
                },
                body: body,
            };

            if (method === "POST") {
                reqInit.headers["Content-Type"] = "application/json";
            }

            return await fetch(url, reqInit);
        }

        function toggleMode(isAdvanced) {
            const easyModeSection = document.getElementById('easyModeSection');
            const codecsDetails = document.getElementById('codecsDetails');

            if (isAdvanced) {
                easyModeSection.style.display = 'none';
                codecsDetails.style.display = 'block';
            } else {
                easyModeSection.style.display = 'block';
                codecsDetails.style.display = 'none';
            }
        }

        (function () {

            var pluginId = "CD893C24-B59E-4060-87B2-184070E1BF68";

            $('.subsExtractorConfigurationPage').on('pageshow', function (event) {

                var page = this;

                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    populateLibraries(config);

                    page.querySelector('#chkEnableDuringScan').checked = !!config.ExtractionDuringLibraryScan;
                    page.querySelector('#chkTextSubtitles').checked = !!config.IncludeTextSubtitles;
                    page.querySelector('#chkGraphicalSubtitles').checked = !!config.IncludeGraphicalSubtitles;
                    page.querySelector('#chkAdvancedMode').checked = !!config.IsAdvancedMode;
                    document.querySelector("#SelectedSubtitlesLibraries").value = config.SelectedSubtitlesLibraries;
                    document.querySelector("#SelectedAttachmentsLibraries").value = config.SelectedAttachmentsLibraries;
                    document.querySelector("#SelectedCodecs").value = config.SelectedCodecs;

                    generateCheckboxList(config.AllSubtitleCodecs.split('#'), "includedCodecsCheckboxes", "SelectedCodecs");

                    const isAdvanced = config.IsAdvancedMode === true;
                    toggleMode(isAdvanced);

                    Dashboard.hideLoadingMsg();
                });
            });

            $('.extractorConfigurationForm').off('submit.plugin').on('submit.plugin', function (e) {

                Dashboard.showLoadingMsg();

                var form = this;

                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    config.ExtractionDuringLibraryScan = form.querySelector('#chkEnableDuringScan').checked;
                    config.IncludeTextSubtitles = form.querySelector('#chkTextSubtitles').checked;
                    config.IncludeGraphicalSubtitles = form.querySelector('#chkGraphicalSubtitles').checked;
                    config.IsAdvancedMode = form.querySelector('#chkAdvancedMode').checked;
                    config.SelectedSubtitlesLibraries = document.querySelector("#SelectedSubtitlesLibraries").value;
                    config.SelectedAttachmentsLibraries = document.querySelector("#SelectedAttachmentsLibraries").value;
                    config.SelectedCodecs = document.querySelector("#SelectedCodecs").value;

                    ApiClient.updatePluginConfiguration(pluginId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                });

                return false;
            });

        })();

        document.querySelector('#chkAdvancedMode').addEventListener('change', function (e) {
            const isAdvanced = e.target.checked;
            toggleMode(isAdvanced);
        });
    </script>
</div>
</body>
</html>
